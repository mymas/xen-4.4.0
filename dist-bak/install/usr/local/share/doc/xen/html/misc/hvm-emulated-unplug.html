<h1>Xen HVM emulated device unplug protocol</h1>

<p>The protocol covers three basic things:</p>

<ul>
<li>Disconnecting emulated devices.</li>
<li>Getting log messages out of the drivers and into dom0.</li>
<li>Allowing dom0 to block the loading of specific drivers.  This is
intended as a backwards-compatibility thing: if we discover a bug
in some old version of the drivers, then rather than working around
it in Xen, we have the option of just making those drivers fall
back to emulated mode.</li>
</ul>

<p>The current protocol works like this (from the point of view of
drivers):</p>

<ol>
<li><p>When the drivers first come up, they check whether the unplug logic
is available by reading a two-byte magic number from IO port <code>0x10</code>.
These should be <code>0x49d2</code>.  If the magic number doesn't match, the
drivers don't do anything.</p></li>
<li><p>The drivers read a one-byte protocol version from IO port <code>0x12</code>.  If
this is 0, skip to 6.</p></li>
<li><p>The drivers write a two-byte product number to IO port <code>0x12</code>.  At
the moment, the only drivers using this protocol are our
closed-source ones, which use product number 1.</p></li>
<li><p>The drivers write a four-byte build number to IO port <code>0x10</code>.</p></li>
<li><p>The drivers check the magic number by reading two bytes from <code>0x10</code>
again.  If it's changed from <code>0x49d2</code> to <code>0xd249</code>, the drivers are
blacklisted and should not load.</p></li>
<li><p>The drivers write a two-byte bitmask of devices to unplug to IO
port <code>0x10</code>.  The defined fields are:</p>

<ul>
<li><code>1</code> -- All IDE disks (not including CD drives)</li>
<li><code>2</code> -- All emulated NICs</li>
<li><code>4</code> -- All IDE disks except for the primary master (not including CD
drives)</li>
</ul>

<p>The relevant emulated devices then disappear from the relevant
buses.  For most guest operating systems, you want to do this
before device enumeration happens.</p></li>
</ol>

<p>Once the drivers have checked the magic number, they can send log
messages to qemu which will be logged to wherever qemu's logs go
(<code>/var/log/xen/qemu-dm.log</code> on normal Xen, dom0 syslog on XenServer).
These messages are written to IO port <code>0x12</code> a byte at a time, and are
terminated by newlines.  There's a fairly aggressive rate limiter on
these messages, so they shouldn't be used for anything even vaguely
high-volume, but they're rather useful for debugging and support.</p>

<p>It is still permitted for a driver to use this logging feature if it
is blacklisted, but <em>ONLY</em> if it has checked the magic number and found
it to be <code>0x49d2</code> or <code>0xd249</code>.</p>

<p>This isn't exactly a pretty protocol, but it does solve the problem.</p>

<p>The blacklist is, from qemu's point of view, handled mostly through
xenstore.  A driver version is considered to be blacklisted if
<code>/mh/driver-blacklist/{product_name}/{build_number}</code> exists and is
readable, where <code>{build_number}</code> is the build number from step 4 as a
decimal number.  <code>{product_name}</code> is a string corresponding to the
product number in step 3.</p>

<p>The master registry of product names and numbers is in
xen/include/public/hvm/pvdrivers.h.</p>

<p>NOTE: The IO ports implementing the unplug protocol are implemented
as part of the Xen Platform PCI Device, so if that device is not
present in the system then this protocol will not work.</p>
