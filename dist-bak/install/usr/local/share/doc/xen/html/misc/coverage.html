<h1>Coverage support for Xen</h1>

<p>Coverare support allow you to get coverage information from Xen execution.
You can see how many times a line is executed.</p>

<p>Some compilers have specific options that enable the collection of this
information. Every basic block in the code will be instrumented by the compiler
to compute these statistics. It should not be used in production as it slows
down your hypervisor.</p>

<h2>Enable coverage</h2>

<p>Test coverage support can be turned on compiling Xen with the <code>coverage</code> option set
to <code>y</code>.</p>

<p>Something like:</p>

<pre><code>cd xen
make coverage=y
</code></pre>

<p>(or change your <code>.config</code> file).</p>

<h2>Extract coverage data</h2>

<p>The way GCC and other tools deal with coverage information is to use some files
created during build phase (.gcno) and some files produced by executing the
<em>program</em> (.gcda). The program in this case is Xen but Xen cannot write files
so the way you can use coverage from Xen is extract coverage data from Xen and
then split these information into files.</p>

<p>To extract data you use a simple utility called <code>xencov</code>. Mainly <code>xencore</code>
allows you to do 3 operations:</p>

<ul>
<li><code>xencov read</code> extract data</li>
<li><code>xencov reset</code> reset all coverage counters</li>
<li><code>xencov read-reset</code> extract data and reset counters at the same time.</li>
</ul>

<p>Another utility (<code>xencov_split</code>) is used to split extracted data file into files
needed by userspace tools.</p>

<h2>Split coverage data</h2>

<p>Once you extracted data from Xen, it is time to create files which the coverage tools
can understand. To do it you need to run <code>xencov_split</code> utility.</p>

<p>The utility just takes an input file and splits the blob into gcc .gcda files
in the same directory that you execute the script. As file names are generated
relative to the current directory, it could be a good idea to run the script
from <code>/</code> on your build machine.</p>

<p>Code for splitting the blob is put in another utility for some reason:
* It is simpler to maintain a high level script than a C program;
* You don't need to execute on the Xen host so you just need to copy the file to
  your development box (you usually need development files anyway).</p>

<h2>Possible use</h2>

<p><strong>This section is just an example on how to use these tools!</strong></p>

<p>This example assumes you compiled Xen from <code>~/xen-unstable</code> and installed into
the host. <strong>Consider that if you even recompile Xen you are not able to use
blob extracted from xencov!</strong></p>

<ul>
<li>Ensure the <code>lcov</code> package is installed</li>
<li><p>From the Xen host machine extract the coverage blob</p>

<pre><code>cd /root
xencov read coverage.dat
</code></pre></li>
<li><p>Copy the extracted blob to your dev machine</p>

<pre><code>cd ~
scp root@myhost:coverage.dat
</code></pre></li>
<li><p>Extract the coverage information</p>

<pre><code>(cd / &amp;&amp; xencov_split ~/coverage.dat)
</code></pre></li>
<li><p>Produce coverage html output</p>

<pre><code>cd ~/xen-unstable
rm -rf cov.info cov
geninfo -o cov.info xen
mkdir cov
genhtml -o cov cov.info
</code></pre></li>
<li><p>See output in a browser</p>

<pre><code>firefox cov/index.html
</code></pre></li>
</ul>
